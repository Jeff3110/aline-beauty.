// Configuração do Supabase
const SUPABASE_URL = 'https://ojsortnbwvevbscwtmdh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qc29ydG5id3ZldmJzY3d0bWRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDg2MjMsImV4cCI6MjA4NzY4NDYyM30.zpKMae0s8OudUgGQdpoVLpHaJ-zefhq77nI0658u6-k';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Elementos da Interface
const navItems = document.querySelectorAll('.nav-item');
const screens = document.querySelectorAll('.screen');
const mainContent = document.getElementById('main-content');

// Lógica de Navegação
navItems.forEach(item => {
    item.addEventListener('click', () => {
        const targetScreen = item.getAttribute('data-screen');

        // Atualizar estado visual da navegação
        navItems.forEach(nav => nav.classList.remove('active'));
        item.classList.add('active');

        // Trocar tela
        switchScreen(targetScreen);
    });
});

function switchScreen(screenId) {
    // Esconder todas as telas que existirem no momento (incluindo as dinâmicas)
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });

    // Mostrar a tela alvo (ou criar se não existir no HTML estático)
    let targetEl = document.getElementById(`screen-${screenId}`);
    if (!targetEl) {
        renderScreen(screenId);
        targetEl = document.getElementById(`screen-${screenId}`);
    }

    if (targetEl) {
        targetEl.classList.add('active');
        // Garantir que a navegação inferior reflita a mudança
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
            if (nav.getAttribute('data-screen') === screenId) nav.classList.add('active');
        });

        // Recarregar dados
        if (screenId === 'dashboard') updateDashboard();
        if (screenId === 'clientes') fetchClients();
        if (screenId === 'agenda') fetchAgenda();
        if (screenId === 'servicos') fetchServicos();
        if (screenId === 'financeiro') fetchFinanceiro();
    }
}

// Renderização dinâmica de telas (para manter o index.html limpo)
function renderScreen(screenId) {
    let content = '';

    switch (screenId) {
        case 'agenda':
            content = `
                <section id="screen-agenda" class="screen active">
                    <header class="header">
                        <h1 class="brand">Agenda</h1>
                        <p class="greeting">Gerencie seus horários</p>
                    </header>

                    <div class="calendar-controls" style="padding: 0 20px 20px; display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="agenda-date-filter" onchange="fetchAgenda()" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <button class="btn-primary" onclick="setAgendaToday()" style="width: auto; padding: 10px 20px;">Hoje</button>
                    </div>

                    <div class="actions-bar" style="padding: 0 20px 20px;">
                        <button class="btn-primary" onclick="showAgendaForm()">
                            <i data-lucide="calendar-plus"></i> Novo Agendamento
                        </button>
                    </div>

                    <div id="agenda-list" class="list-container" style="padding: 0 20px;">
                        <p style="text-align:center; color:#999; padding: 20px;">Carregando agenda...</p>
                    </div>
                </section>

                <!-- Modal de Agendamento -->
                <div id="modal-agenda" class="modal">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2>Novo Agendamento</h2>
                            <button class="close-btn" onclick="hideAgendaForm()">&times;</button>
                        </header>
                        <form id="form-agenda">
                            <div class="form-group">
                                <label>Cliente*</label>
                                <select id="a-cliente" required>
                                    <option value="">Selecione um cliente...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Serviço*</label>
                                <select id="a-servico" required onchange="updateAgendaPrice()">
                                    <option value="">Selecione um serviço...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data e Hora*</label>
                                <input type="datetime-local" id="a-data" required>
                            </div>
                            <div class="form-group">
                                <label>Valor Total (R$)</label>
                                <input type="number" id="a-valor" step="0.01" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Valor de Entrada / Sinal (R$)</label>
                                <input type="number" id="a-entrada" step="0.01" placeholder="0,00" style="border: 2px solid var(--accent-color);">
                                <small style="color: var(--accent-color);">Este valor irá direto para o caixa de hoje.</small>
                            </div>
                            <button type="submit" class="btn-primary" id="btn-save-agenda">Agendar</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(fetchAgenda, 100);
            break;
        case 'clientes':
            content = `
                <section id="screen-clientes" class="screen active">
                    <header class="header">
                        <h1 class="brand">Clientes</h1>
                        <p class="greeting">Sua lista de contatos</p>
                    </header>
                    
                    <div class="actions-bar" style="padding: 0 20px 20px;">
                        <button class="btn-primary" onclick="showClientForm()">
                            <i data-lucide="user-plus"></i> Novo Cliente
                        </button>
                    </div>

                    <div class="search-bar" style="padding: 0 20px 20px;">
                        <input type="text" id="client-search" placeholder="Buscar cliente..." onkeyup="filterClients()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>

                    <div id="clients-list" class="list-container" style="padding: 0 20px;">
                        <p style="text-align:center; color:#999; padding: 20px;">Carregando clientes...</p>
                    </div>
                </section>

                <!-- Modal de Cliente -->
                <div id="modal-client" class="modal">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2>Novo Cliente</h2>
                            <button class="close-btn" onclick="hideClientForm()">&times;</button>
                        </header>
                        <form id="form-client">
                            <div class="form-group">
                                <label>Nome Completo*</label>
                                <input type="text" id="c-nome" required>
                            </div>
                            <div class="form-group">
                                <label>Telefone/WhatsApp</label>
                                <input type="tel" id="c-telefone" placeholder="(00) 00000-0000">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="c-instagram" placeholder="@usuario">
                            </div>
                            <div class="form-group">
                                <label>Observações</label>
                                <textarea id="c-obs" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn-primary" id="btn-save-client">Salvar Cliente</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(fetchClients, 100);
            break;
        case 'servicos':
            content = `
                <section id="screen-servicos" class="screen active">
                    <header class="header">
                        <h1 class="brand">Serviços</h1>
                        <p class="greeting">Catálogo de Procedimentos</p>
                    </header>
                    
                    <div class="actions-bar" style="padding: 0 20px 20px;">
                        <button class="btn-primary" onclick="showServicoForm()">
                            <i data-lucide="plus"></i> Novo Serviço
                        </button>
                    </div>

                    <div id="servicos-list" class="list-container" style="padding: 0 20px;">
                        <p style="text-align:center; color:#999; padding: 20px;">Carregando serviços...</p>
                    </div>
                </section>

                <!-- Modal de Serviço -->
                <div id="modal-servico" class="modal">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2 id="s-modal-title">Novo Serviço</h2>
                            <button class="close-btn" onclick="hideServicoForm()">&times;</button>
                        </header>
                        <form id="form-servico">
                            <input type="hidden" id="s-id">
                            <div class="form-group">
                                <label>Nome do Serviço*</label>
                                <input type="text" id="s-nome" required placeholder="Ex: Maquiagem Social">
                            </div>
                            <div class="form-group">
                                <label>Valor Sugerido (R$)*</label>
                                <input type="number" id="s-valor" step="0.01" required placeholder="0,00">
                            </div>
                            <button type="submit" class="btn-primary" id="btn-save-servico">Salvar Serviço</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(fetchServicos, 100);
            break;
        case 'financeiro':
            content = `
                <section id="screen-financeiro" class="screen active">
                    <header class="header">
                        <h1 class="brand">Finanças</h1>
                        <p class="greeting">Fluxo de Caixa</p>
                    </header>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 20px 20px;">
                        <div class="filter-bar" id="fin-filters" style="padding: 0; margin: 0; flex: 1;">
                            <button class="filter-btn active" onclick="setFinanceiroFilter('dia')">Dia</button>
                            <button class="filter-btn" onclick="setFinanceiroFilter('semana')">Semana</button>
                            <button class="filter-btn" onclick="setFinanceiroFilter('mes')">Mês</button>
                            <button class="filter-btn" onclick="setFinanceiroFilter('ano')">Ano</button>
                            <button class="filter-btn" onclick="setFinanceiroFilter('custom')">Personalizado</button>
                        </div>
                        <button class="btn-primary" onclick="toggleAcerto()" style="width: auto; padding: 8px 15px; background: var(--accent-color); font-size: 0.8rem; margin-left: 10px;">
                            <i data-lucide="calculator"></i> Acerto
                        </button>
                    </div>

                    <div id="acerto-display" style="display: none; padding: 0 20px 20px;">
                        <div style="background: white; border: 2px solid var(--accent-color); border-radius: 12px; padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <span style="display:block; font-size: 0.65rem; color: #666;">40%</span>
                                <span id="acerto-40" style="color: #2ecc71; font-weight: 700; font-size: 0.9rem;">R$ 0,00</span>
                            </div>
                            <div>
                                <span style="display:block; font-size: 0.65rem; color: #666;">50%</span>
                                <span id="acerto-50" style="color: #2ecc71; font-weight: 700; font-size: 0.9rem;">R$ 0,00</span>
                            </div>
                            <div>
                                <span style="display:block; font-size: 0.65rem; color: #666;">60%</span>
                                <span id="acerto-60" style="color: #2ecc71; font-weight: 700; font-size: 0.9rem;">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <div id="fin-custom-date" style="display: none; padding: 0 20px 20px; gap: 10px;">
                        <input type="date" id="f-start-date" onchange="fetchFinanceiro()" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                        <input type="date" id="f-end-date" onchange="fetchFinanceiro()" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>

                    <div class="stats-grid" style="grid-template-columns: 1fr; padding-bottom: 0;">
                        <div class="stat-card highlight" style="text-align: center; border: 2px solid var(--accent-color);">
                            <span class="stat-label">Caixa Real (Saldo Líquido)</span>
                            <span id="fin-saldo" class="stat-value" style="font-size: 2rem;">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="stats-grid" style="padding-top: 15px;">
                        <div class="stat-card">
                            <span class="stat-label">Entradas (+)</span>
                            <span id="fin-entradas" class="stat-value" style="color: #2ecc71; font-size: 1.2rem;">R$ 0,00</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Saídas (-)</span>
                            <span id="fin-saidas" class="stat-value" style="color: #e74c3c; font-size: 1.2rem;">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="actions-bar" style="padding: 0 20px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-primary" onclick="showFinanceiroForm('entrada')" style="background-color: #2ecc71;">
                            <i data-lucide="plus-circle"></i> Entrada
                        </button>
                        <button class="btn-primary" onclick="showFinanceiroForm('saida')" style="background-color: #e74c3c;">
                            <i data-lucide="minus-circle"></i> Saída
                        </button>
                    </div>

                    <div id="financeiro-list" class="list-container" style="padding: 0 20px;">
                        <p style="text-align:center; color:#999; padding: 20px;">Carregando finanças...</p>
                    </div>
                </section>

                <!-- Modal de Financeiro -->
                <div id="modal-financeiro" class="modal">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2 id="fin-modal-title">Nova Transação</h2>
                            <button class="close-btn" onclick="hideFinanceiroForm()">&times;</button>
                        </header>
                        <form id="form-financeiro">
                            <input type="hidden" id="f-tipo">
                            <div class="form-group">
                                <label>Descrição*</label>
                                <input type="text" id="f-descricao" placeholder="Ex: Pagamento Maquiagem ou Compra de Blush" required>
                            </div>
                            <div class="form-group">
                                <label>Valor (R$)*</label>
                                <input type="number" id="f-valor" step="0.01" placeholder="0,00" required>
                            </div>
                            <div class="form-group">
                                <label>Data*</label>
                                <input type="date" id="f-data" required>
                            </div>
                            <button type="submit" class="btn-primary" id="btn-save-financeiro">Salvar</button>
                        </form>
                    </div>
                </div>

                <!-- Modal de Edição (Geral) -->
                <div id="modal-edit-financeiro" class="modal">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h2>Editar Transação</h2>
                            <button class="close-btn" onclick="hideEditFinForm()">&times;</button>
                        </header>
                        <form id="form-edit-financeiro">
                            <input type="hidden" id="ef-id">
                            <div class="form-group">
                                <label>Descrição*</label>
                                <input type="text" id="ef-descricao" required>
                            </div>
                            <div class="form-group">
                                <label>Valor (R$)*</label>
                                <input type="number" id="ef-valor" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Data*</label>
                                <input type="date" id="ef-data" required>
                            </div>
                            <button type="submit" class="btn-primary">Atualizar</button>
                        </form>
                    </div>
                </div>
            `;
            break;
    }

    mainContent.insertAdjacentHTML('beforeend', content);
    lucide.createIcons();
}

// --- MÓDULO DE CLIENTES ---

let allClients = [];

async function fetchClients() {
    const listEl = document.getElementById('clients-list');
    if (!listEl) return;

    try {
        const { data, error } = await supabaseClient
            .from('clientes')
            .select('*')
            .order('nome', { ascending: true });

        if (error) throw error;

        allClients = data;
        renderClients(data);
    } catch (err) {
        console.error('Erro ao buscar clientes:', err);
        listEl.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar clientes.</p>`;
    }
}

function renderClients(clients) {
    const listEl = document.getElementById('clients-list');
    if (!listEl) return;

    if (clients.length === 0) {
        listEl.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">Nenhum cliente cadastrado.</p>`;
        return;
    }

    listEl.innerHTML = clients.map(c => `
        <div class="card client-card" style="margin-bottom: 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="font-family: 'Montserrat', sans-serif; font-size: 1rem; margin-bottom: 2px;">${c.nome}</h3>
                <p style="font-size: 0.8rem; color: #666;">${c.telefone || 'Sem telefone'}</p>
            </div>
            <button class="btn-icon" onclick="openWhatsApp('${c.telefone}')" style="background:none; border:none; color: #25D366; cursor: pointer;">
                <i data-lucide="phone"></i>
            </button>
        </div>
    `).join('');
    lucide.createIcons();
}

function filterClients() {
    const query = document.getElementById('client-search').value.toLowerCase();
    const filtered = allClients.filter(c => c.nome.toLowerCase().includes(query));
    renderClients(filtered);
}

function showClientForm() {
    document.getElementById('modal-client').classList.add('active');
}

function hideClientForm() {
    document.getElementById('modal-client').classList.remove('active');
    document.getElementById('form-client').reset();
}

// Interceptar envio do formulário
document.addEventListener('submit', async (e) => {
    if (e.target.id === 'form-client') {
        e.preventDefault();
        console.log('--- Iniciando Cadastro de Cliente ---');

        const btn = document.getElementById('btn-save-client');
        btn.disabled = true;
        btn.innerText = 'Salvando...';

        const clientData = {
            nome: document.getElementById('c-nome').value,
            telefone: document.getElementById('c-telefone').value,
            instagram: document.getElementById('c-instagram').value,
            observacoes: document.getElementById('c-obs').value
        };

        console.log('Dados coletados:', clientData);

        if (!supabaseClient) {
            console.error('Erro: supabaseClient não foi inicializado!');
            alert('Erro: O sistema de banco de dados não carregou corretamente.');
            btn.disabled = false;
            btn.innerText = 'Salvar Cliente';
            return;
        }

        try {
            const { data, error } = await supabaseClient
                .from('clientes')
                .insert([clientData])
                .select();

            if (error) {
                console.error('Erro retornado pelo Supabase:', error);
                throw error;
            }

            console.log('Resposta de sucesso do Supabase:', data);

            hideClientForm();
            fetchClients();
            alert('✅ Cliente salvo com sucesso!');
        } catch (err) {
            console.error('Falha catastrófica ao salvar:', err);
            alert('❌ Erro ao salvar cliente!\n\nDetalhe: ' + (err.message || 'Erro desconhecido. Verifique se o SQL foi rodado no painel do Supabase.'));
        } finally {
            btn.disabled = false;
            btn.innerText = 'Salvar Cliente';
        }
    }
});

function openWhatsApp(phone) {
    if (!phone) return;
    const cleanPhone = phone.replace(/\D/g, '');
    window.open(`https://wa.me/55${cleanPhone}`, '_blank');
}

// --- MÓDULO DE AGENDA ---

function setAgendaToday() {
    const filter = document.getElementById('agenda-date-filter');
    if (filter) {
        filter.valueAsDate = new Date();
        fetchAgenda();
    }
}

async function fetchAgenda() {
    const listEl = document.getElementById('agenda-list');
    const dateFilter = document.getElementById('agenda-date-filter');
    if (!listEl) return;

    // Se o filtro não estiver definido, colocar hoje como padrão
    if (dateFilter && !dateFilter.value) {
        dateFilter.valueAsDate = new Date();
    }

    const selectedDate = dateFilter ? dateFilter.value : null;

    try {
        let query = supabaseClient
            .from('agendamentos')
            .select('*, clientes(nome)')
            .order('data_hora', { ascending: true });

        // Filtrar por data se selecionado
        if (selectedDate) {
            const startOfDay = `${selectedDate}T00:00:00Z`;
            const endOfDay = `${selectedDate}T23:59:59Z`;
            query = query.gte('data_hora', startOfDay).lte('data_hora', endOfDay);
        }

        const { data, error } = await query;
        if (error) throw error;

        renderAgenda(data);
    } catch (err) {
        console.error('Erro ao buscar agenda:', err);
        listEl.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar agenda.</p>`;
    }
}

function renderAgenda(items) {
    const listEl = document.getElementById('agenda-list');
    if (!listEl) return;

    if (items.length === 0) {
        listEl.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">Nenhum agendamento para hoje.</p>`;
        return;
    }

    listEl.innerHTML = items.map(item => {
        const date = new Date(item.data_hora);
        const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const dateStr = date.toLocaleDateString('pt-BR');

        const valorTotal = parseFloat(item.valor || 0);
        const valorPago = parseFloat(item.valor_pago || 0);
        const restante = valorTotal - valorPago;

        return `
            <div class="card agenda-card" style="margin-bottom: 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <span style="font-size: 0.7rem; color: var(--accent-color); font-weight: 600; text-transform: uppercase;">${timeStr} - ${dateStr}</span>
                        <h3 style="font-family: 'Montserrat', sans-serif; font-size: 1rem; margin: 4px 0;">${item.clientes?.nome || 'Cliente não encontrado'}</h3>
                    </div>
                    <div style="text-align: right;">
                        <span style="display:block; font-size: 0.8rem; font-weight: 600;">Total: R$ ${valorTotal.toFixed(2)}</span>
                        ${restante > 0 ? `<span style="display:block; font-size: 0.75rem; color: #e74c3c;">Falta: R$ ${restante.toFixed(2)}</span>` : '<span style="display:block; font-size: 0.75rem; color: #2ecc71;">Pago ✅</span>'}
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.85rem; color: #666;">${item.servico}</span>
                    <div style="display: flex; gap: 8px;">
                        ${restante > 0 ? `<button onclick="quitarSaldo('${item.id}', ${restante}, '${item.clientes?.nome || 'Cliente'}')" style="background: var(--accent-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Liquidar Restante</button>` : ''}
                        <span style="font-size: 0.75rem; color: ${item.status === 'concluido' ? 'green' : '#d4a373'};">${item.status}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function quitarSaldo(id, restante, nomeCliente) {
    if (!confirm(`Deseja liquidar o saldo de R$ ${restante.toFixed(2)} deste serviço?`)) return;

    try {
        // Buscar agendamento atual para somar o valor_pago
        const { data: agenda } = await supabaseClient.from('agendamentos').select('valor, valor_pago').eq('id', id).single();
        const novoPago = parseFloat(agenda.valor_pago || 0) + restante;

        const { error } = await supabaseClient
            .from('agendamentos')
            .update({ valor_pago: novoPago, pago: true })
            .eq('id', id);

        if (error) throw error;

        // Registrar no financeiro de HOJE
        const finData = {
            tipo: 'entrada',
            descricao: `Acerto: ${nomeCliente}`,
            valor: restante,
            data: new Date().toISOString().split('T')[0],
            agendamento_id: id
        };
        await supabaseClient.from('financeiro').insert([finData]);

        alert('✅ Saldo liquidado e registrado no caixa de hoje!');
        fetchAgenda();
        updateDashboard();
    } catch (err) {
        alert('❌ Erro ao liquidar: ' + err.message);
    }
}

async function showAgendaForm() {
    document.getElementById('modal-agenda').classList.add('active');

    // Carregar clientes para o select
    const select = document.getElementById('a-cliente');
    select.innerHTML = '<option value="">Carregando clientes...</option>';

    try {
        const { data, error } = await supabaseClient.from('clientes').select('id, nome').order('nome');
        if (error) throw error;

        select.innerHTML = '<option value="">Selecione um cliente...</option>' +
            data.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

        // Carregar serviços para o select
        const sSelect = document.getElementById('a-servico');
        const { data: servicos } = await supabaseClient.from('servicos').select('*').order('nome');
        if (servicos) {
            sSelect.innerHTML = '<option value="">Selecione um serviço...</option>' +
                servicos.map(s => `<option value="${s.nome}" data-valor="${s.valor}">${s.nome}</option>`).join('');
        }
    } catch (err) {
        select.innerHTML = '<option value="">Erro ao carregar clientes</option>';
    }
}

function hideAgendaForm() {
    document.getElementById('modal-agenda').classList.remove('active');
    document.getElementById('form-agenda').reset();
}

// Interceptar envio do formulário de agenda
document.addEventListener('submit', async (e) => {
    if (e.target.id === 'form-agenda') {
        e.preventDefault();
        const btn = document.getElementById('btn-save-agenda');
        btn.disabled = true;
        btn.innerText = 'Salvando...';

        const entradaValor = parseFloat(document.getElementById('a-entrada').value || 0);

        const agendaData = {
            cliente_id: document.getElementById('a-cliente').value,
            servico: document.getElementById('a-servico').value,
            data_hora: document.getElementById('a-data').value,
            valor: parseFloat(document.getElementById('a-valor').value || 0),
            valor_pago: entradaValor,
            status: 'pendente'
        };

        try {
            const { data: newAgenda, error } = await supabaseClient.from('agendamentos').insert([agendaData]).select();
            if (error) throw error;

            // Se houver entrada, registrar no financeiro para HOJE
            if (entradaValor > 0) {
                const clienteSelect = document.getElementById('a-cliente');
                const clienteNome = clienteSelect.options[clienteSelect.selectedIndex].text;
                const finData = {
                    tipo: 'entrada',
                    descricao: `Entrada: ${clienteNome}`,
                    valor: entradaValor,
                    data: new Date().toISOString(),
                    agendamento_id: newAgenda[0].id
                };
                await supabaseClient.from('financeiro').insert([finData]);
            }

            hideAgendaForm();
            fetchAgenda();
            updateDashboard();
            alert('✅ Agendamento e entrada registrados!');
        } catch (err) {
            alert('❌ Erro: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = 'Agendar';
        }
    }
});

// --- MÓDULO FINANCEIRO ---

let currentFinFilter = 'dia';

function setFinanceiroFilter(filter) {
    currentFinFilter = filter;

    // Atualizar UI dos botões
    document.querySelectorAll('#fin-filters .filter-btn').forEach(btn => {
        const text = btn.innerText.toLowerCase();
        const target = filter === 'custom' ? 'personalizado' : filter;
        btn.classList.toggle('active', text === target || (filter === 'mes' && text === 'mês'));
    });

    // Mostrar/esconder campos de data customizada
    const customDiv = document.getElementById('fin-custom-date');
    if (customDiv) customDiv.style.display = filter === 'custom' ? 'flex' : 'none';

    fetchFinanceiro();
}

async function fetchFinanceiro() {
    const listEl = document.getElementById('financeiro-list');
    if (!listEl) return;

    try {
        let query = supabaseClient.from('financeiro').select('*');

        const now = new Date();
        let start = new Date();
        let end = new Date();

        switch (currentFinFilter) {
            case 'dia':
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                break;
            case 'semana':
                const day = now.getDay();
                start.setDate(now.getDate() - day);
                start.setHours(0, 0, 0, 0);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                break;
            case 'mes':
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                end.setHours(23, 59, 59, 999);
                break;
            case 'ano':
                start = new Date(now.getFullYear(), 0, 1);
                end = new Date(now.getFullYear(), 11, 31);
                end.setHours(23, 59, 59, 999);
                break;
            case 'custom':
                const sd = document.getElementById('f-start-date').value;
                const ed = document.getElementById('f-end-date').value;
                if (sd && ed) {
                    start = new Date(sd + 'T00:00:00');
                    end = new Date(ed + 'T23:59:59');
                } else {
                    // Se não preencheu, não filtra nada ou mostra aviso
                    listEl.innerHTML = '<p style="text-align:center; padding:20px;">Selecione o período...</p>';
                    return;
                }
                break;
        }

        query = query.gte('data', start.toISOString()).lte('data', end.toISOString());

        const { data, error } = await query.order('data', { ascending: false });
        if (error) throw error;

        renderFinanceiro(data);
        calculateTotals(data);
    } catch (err) {
        console.error('Erro ao buscar finanças:', err);
        listEl.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar dados.</p>`;
    }
}

async function deleteFinanceiro(id) {
    if (!confirm('Tem certeza que deseja apagar esta transação?')) return;

    try {
        const { error } = await supabaseClient.from('financeiro').delete().eq('id', id);
        if (error) throw error;
        alert('✅ Transação removida!');
        fetchFinanceiro();
        updateDashboard();
    } catch (err) {
        alert('❌ Erro ao apagar: ' + err.message);
    }
}

async function editFinanceiro(id) {
    try {
        const { data, error } = await supabaseClient.from('financeiro').select('*').eq('id', id).single();
        if (error) throw error;

        document.getElementById('ef-id').value = data.id;
        document.getElementById('ef-descricao').value = data.descricao;
        document.getElementById('ef-valor').value = data.valor;
        document.getElementById('ef-data').value = data.data.split('T')[0];

        document.getElementById('modal-edit-financeiro').classList.add('active');
    } catch (err) {
        alert('❌ Erro ao carregar transação: ' + err.message);
    }
}

function hideEditFinForm() {
    document.getElementById('modal-edit-financeiro').classList.remove('active');
}

document.addEventListener('submit', async (e) => {
    if (e.target.id === 'form-edit-financeiro') {
        e.preventDefault();
        const id = document.getElementById('ef-id').value;
        const updateData = {
            descricao: document.getElementById('ef-descricao').value,
            valor: parseFloat(document.getElementById('ef-valor').value),
            data: document.getElementById('ef-data').value
        };

        try {
            const { error } = await supabaseClient.from('financeiro').update(updateData).eq('id', id);
            if (error) throw error;

            hideEditFinForm();
            fetchFinanceiro();
            updateDashboard();
            alert('✅ Transação atualizada!');
        } catch (err) {
            alert('❌ Erro ao atualizar: ' + err.message);
        }
    }
});

function renderFinanceiro(items) {
    const listEl = document.getElementById('financeiro-list');
    if (!listEl) return;

    if (items.length === 0) {
        listEl.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">Nenhuma movimentação registrada.</p>`;
        return;
    }

    listEl.innerHTML = items.map(item => `
        <div class="card fin-card" style="margin-bottom: 15px; padding: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <h3 style="font-family: 'Montserrat', sans-serif; font-size: 0.95rem; margin-bottom: 2px;">${item.descricao}</h3>
                <p style="font-size: 0.75rem; color: #666;">${new Date(item.data).toLocaleDateString('pt-BR')}</p>
            </div>
            <div style="text-align: right; display: flex; align-items: center; gap: 12px;">
                <span style="font-weight: 600; color: ${item.tipo === 'entrada' ? '#2ecc71' : '#e74c3c'};">
                    ${item.tipo === 'entrada' ? '+' : '-'} R$ ${item.valor.toFixed(2)}
                </span>
                <div class="card-actions">
                    <button onclick="editFinanceiro('${item.id}')" class="action-btn edit"><i data-lucide="edit-2" style="width: 16px; height: 16px;"></i></button>
                    <button onclick="deleteFinanceiro('${item.id}')" class="action-btn delete"><i data-lucide="trash-2" style="width: 16px; height: 16px;"></i></button>
                </div>
            </div>
        </div>
    `).join('');
    lucide.createIcons();
}

function calculateTotals(items) {
    const totalEntradas = items
        .filter(i => i.tipo === 'entrada')
        .reduce((sum, i) => sum + parseFloat(i.valor), 0);

    const totalSaidas = items
        .filter(i => i.tipo === 'saida')
        .reduce((sum, i) => sum + parseFloat(i.valor), 0);

    const saldoReal = totalEntradas - totalSaidas;

    document.getElementById('fin-entradas').innerText = `R$ ${totalEntradas.toFixed(2)}`;
    document.getElementById('fin-saidas').innerText = `R$ ${totalSaidas.toFixed(2)}`;
    document.getElementById('fin-saldo').innerText = `R$ ${saldoReal.toFixed(2)}`;

    // Atualizar Acerto (40, 50, 60% do Saldo Real)
    document.getElementById('acerto-40').innerText = `R$ ${(saldoReal * 0.4).toFixed(2)}`;
    document.getElementById('acerto-50').innerText = `R$ ${(saldoReal * 0.5).toFixed(2)}`;
    document.getElementById('acerto-60').innerText = `R$ ${(saldoReal * 0.6).toFixed(2)}`;

    // Cor dinâmica para o saldo
    const saldoEl = document.getElementById('fin-saldo');
    if (saldoReal > 0) saldoEl.style.color = '#2ecc71';
    else if (saldoReal < 0) saldoEl.style.color = '#e74c3c';
    else saldoEl.style.color = 'var(--secondary-color)';
}

function toggleAcerto() {
    const display = document.getElementById('acerto-display');
    if (display.style.display === 'none') {
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

function showFinanceiroForm(tipo) {
    document.getElementById('modal-financeiro').classList.add('active');
    document.getElementById('f-tipo').value = tipo;
    document.getElementById('f-data').valueAsDate = new Date();
    document.getElementById('fin-modal-title').innerText = tipo === 'entrada' ? 'Nova Entrada' : 'Nova Saída';
}

function hideFinanceiroForm() {
    document.getElementById('modal-financeiro').classList.remove('active');
    document.getElementById('form-financeiro').reset();
}

document.addEventListener('submit', async (e) => {
    if (e.target.id === 'form-financeiro') {
        e.preventDefault();
        const btn = document.getElementById('btn-save-financeiro');
        btn.disabled = true;
        btn.innerText = 'Salvando...';

        const finData = {
            tipo: document.getElementById('f-tipo').value,
            descricao: document.getElementById('f-descricao').value,
            valor: parseFloat(document.getElementById('f-valor').value),
            data: document.getElementById('f-data').value
        };

        try {
            const { error } = await supabaseClient.from('financeiro').insert([finData]);
            if (error) throw error;

            hideFinanceiroForm();
            fetchFinanceiro();
            alert('✅ Registro salvo!');
        } catch (err) {
            alert('❌ Erro ao salvar: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = 'Salvar';
        }
    }
});

// --- MÓDULO DE SERVIÇOS ---

async function fetchServicos() {
    const listEl = document.getElementById('servicos-list');
    if (!listEl) return;

    try {
        const { data, error } = await supabaseClient.from('servicos').select('*').order('nome');
        if (error) throw error;
        renderServicos(data);
    } catch (err) {
        console.error('Erro ao buscar serviços:', err);
        listEl.innerHTML = `<p style="color:red; text-align:center;">Erro ao carregar serviços.</p>`;
    }
}

function renderServicos(items) {
    const listEl = document.getElementById('servicos-list');
    if (!listEl) return;

    if (items.length === 0) {
        listEl.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">Nenhum serviço cadastrado.</p>`;
        return;
    }

    listEl.innerHTML = items.map(item => `
        <div class="card" style="margin-bottom: 15px; padding:15px; border-radius:12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="font-family:'Montserrat', sans-serif; font-size:1rem; margin-bottom:2px;">${item.nome}</h3>
                <p style="font-size:0.85rem; color:var(--accent-color); font-weight:600;">R$ ${item.valor.toFixed(2)}</p>
            </div>
            <button onclick="deleteServico('${item.id}')" class="action-btn delete">
                <i data-lucide="trash-2" style="width:20px; height:20px;"></i>
            </button>
        </div>
    `).join('');
    lucide.createIcons();
}

function showServicoForm() {
    document.getElementById('modal-servico').classList.add('active');
    document.getElementById('form-servico').reset();
    document.getElementById('s-id').value = '';
}

function hideServicoForm() {
    document.getElementById('modal-servico').classList.remove('active');
}

async function deleteServico(id) {
    if (!confirm('Deseja excluir este serviço do catálogo?')) return;
    try {
        const { error } = await supabaseClient.from('servicos').delete().eq('id', id);
        if (error) throw error;
        fetchServicos();
    } catch (err) {
        alert('Erro ao excluir: ' + err.message);
    }
}

function updateAgendaPrice() {
    const select = document.getElementById('a-servico');
    const selectedOption = select.options[select.selectedIndex];
    const valor = selectedOption.getAttribute('data-valor');
    if (valor) {
        document.getElementById('a-valor').value = valor;
    }
}

document.addEventListener('submit', async (e) => {
    if (e.target.id === 'form-servico') {
        e.preventDefault();
        const btn = document.getElementById('btn-save-servico');
        btn.disabled = true;
        btn.innerText = 'Salvando...';

        const servicoData = {
            nome: document.getElementById('s-nome').value,
            valor: parseFloat(document.getElementById('s-valor').value)
        };

        try {
            const { error } = await supabaseClient.from('servicos').insert([servicoData]);
            if (error) throw error;

            hideServicoForm();
            fetchServicos();
            alert('✅ Serviço cadastrado com sucesso!');
        } catch (err) {
            alert('❌ Erro ao salvar serviço: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = 'Salvar Serviço';
        }
    }
});

async function updateDashboard() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const startOfDay = `${today}T00:00:00Z`;
        const endOfDay = `${today}T23:59:59Z`;

        // Contar agendamentos de hoje
        const { data: agenda } = await supabaseClient
            .from('agendamentos')
            .select('id')
            .gte('data_hora', startOfDay)
            .lte('data_hora', endOfDay);

        // Somar entradas financeiras de hoje (incluindo entradas de serviços futuros)
        const { data: finEntries } = await supabaseClient
            .from('financeiro')
            .select('valor')
            .eq('tipo', 'entrada')
            .gte('data', startOfDay)
            .lte('data', endOfDay);

        const count = agenda?.length || 0;
        const revenue = finEntries?.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0) || 0;

        // Atualizar no HTML
        document.querySelectorAll('.stat-card').forEach(card => {
            const label = card.querySelector('.stat-label')?.innerText;
            const valueEl = card.querySelector('.stat-value');
            if (label === 'HOJE') valueEl.innerText = count;
            if (label === 'RECEITA DO DIA') valueEl.innerText = `R$ ${revenue.toFixed(2)}`;
        });
    } catch (err) {
        console.error('Erro ao atualizar dashboard:', err);
    }
}

// Inicialização
window.addEventListener('DOMContentLoaded', () => {
    console.log('Atelier Aline Silva pronto!');
    lucide.createIcons();
    updateDashboard(); // Carregar stats iniciais

    // Registrar Service Worker para PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker registrado!'))
            .catch(err => console.log('Erro no Service Worker:', err));
    }
});
